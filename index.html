<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NZM IPTV</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    * {margin: 0; padding: 0; box-sizing: border-box; font-family: 'Orbitron', sans-serif;}
    html, body {height: 100%; background: black; color: white; overflow: hidden;}

    #loginSection {
      background: url('https://i.imgur.com/yeftKeD.jpeg') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .login-box {
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
      padding: 30px 40px;
      border-radius: 15px;
      text-align: center;
    }
    .login-box h2 { margin-bottom: 20px; }
    .login-box input {
      display: block;
      width: 250px;
      margin: 10px auto;
      padding: 10px;
      border-radius: 8px;
      border: none;
    }
    .login-box button {
      background: hotpink;
      padding: 10px 25px;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      margin-top: 10px;
    }

    #iptvSection {
      display: none;
      height: 100vh;
      background: url('https://i.imgur.com/yeftKeD.jpeg') no-repeat center center fixed;
      background-size: cover;
      overflow-y: auto;
      padding: 10px;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
    }
    .logout-btn {
      margin-left: auto;
      background: #ff0040;
      padding: 5px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    video {
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
      background: black;
    }

    #reconnecting {
      display: none;
      color: red;
      margin-top: 5px;
      font-weight: bold;
    }

    #nowChannel {
      text-align: center;
      margin: 10px 0;
      font-weight: bold;
    }

    .carousel {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding: 10px;
      scroll-snap-type: x mandatory;
    }
    .carousel button {
      flex-shrink: 0;
      background: #222;
      color: white;
      border: none;
      border-radius: 15px;
      padding: 6px 16px;
    }
    .carousel button.active {
      background: hotpink;
    }

    #search {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 10px;
      font-size: 16px;
    }

    #channelList {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      gap: 12px;
      padding-bottom: 10px;
    }
    .channel {
      flex: 0 0 48%;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(8px);
      border-radius: 12px;
      padding: 10px;
      text-align: center;
      scroll-snap-align: start;
    }
    .channel img {
      width: 100%;
      height: 100px;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <div id="loginSection">
    <div class="login-box">
      <h2>NZM IPTV Login</h2>
      <input id="email" type="text" placeholder="Username">
      <input id="password" type="password" placeholder="Password">
      <button onclick="login()">Login</button>
      <p id="loginError" style="color:red;margin-top:10px"></p>
    </div>
  </div>

  <div id="iptvSection">
    <div class="header">
      <img src="logo.png" alt="Logo">
      <div class="logout-btn" onclick="logout()">Logout</div>
    </div>
    <video id="player" controls autoplay muted></video>
    <div id="reconnecting">Reconnecting stream...</div>
    <div id="nowChannel">Now Playing</div>
    <input id="search" placeholder="Search channels..." oninput="renderChannels()">
    <div id="categoryList" class="carousel"></div>
    <div id="channelList"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDssixgarRWvLMKtUsX7HLEt8uPGmNIRak",
      authDomain: "iptv-login-3204b.firebaseapp.com",
      databaseURL: "https://iptv-login-3204b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "iptv-login-3204b",
      storageBucket: "iptv-login-3204b.appspot.com",
      messagingSenderId: "464216999882",
      appId: "1:464216999882:web:d7e1f7d44adacd8b46b133"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;
    let playlist = [];
    let categories = [];
    let currentCategory = 'All';
    let currentChannel = null;
    let lastActivity = Date.now();
    let offlineStart = null;

    const login = () => {
      const user = document.getElementById('email').value.trim();
      const pass = document.getElementById('password').value.trim();
      if (!user || !pass) return alert("Enter credentials");

      db.ref('users/' + user).once('value').then(snap => {
        if (!snap.exists()) return showError("Account not found");
        const data = snap.val();
        if (data.password !== pass) return showError("Wrong password");

        const exp = new Date(data.expiration);
        if (new Date() > exp) return showError("Account expired");

        // Device limit
        let sessions = data.sessions || {};
        const sessionId = navigator.userAgent + '_' + Math.random();
        sessions[sessionId] = Date.now();
        const activeSessions = Object.values(sessions).filter(t => Date.now() - t < 3600000); // 1hr
        if (activeSessions.length > data.device_limit) return showError("Device limit reached");

        db.ref('users/' + user + '/sessions').set(sessions);

        currentUser = user;
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('iptvSection').style.display = 'block';
        loadPlaylist();
        trackActivity();
      });
    };

    const showError = msg => {
      document.getElementById('loginError').innerText = msg;
    };

    const logout = () => {
      currentUser = null;
      location.reload();
    };

    const loadPlaylist = () => {
      fetch('https://raw.githubusercontent.com/PRENDLYMADAPAKER/ANG-KALAT-MO/main/UDPTV.m3u')
        .then(res => res.text())
        .then(parseM3U);
      setInterval(loadPlaylist, 180000);
    };

    const parseM3U = text => {
      const lines = text.split("\n");
      playlist = [];
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith('#EXTINF')) {
          const name = lines[i].split(',')[1];
          const logoMatch = lines[i].match(/tvg-logo="(.*?)"/);
          const logo = logoMatch ? logoMatch[1] : '';
          const url = lines[i + 1];
          const groupMatch = lines[i].match(/group-title="(.*?)"/);
          const group = groupMatch ? groupMatch[1] : 'Other';
          playlist.push({ name, logo, url, group });
        }
      }
      categories = ['All', ...new Set(playlist.map(p => p.group))];
      renderCategories();
      renderChannels();
    };

    const renderCategories = () => {
      const catDiv = document.getElementById('categoryList');
      catDiv.innerHTML = '';
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.innerText = cat;
        btn.className = (cat === currentCategory) ? 'active' : '';
        btn.onclick = () => {
          currentCategory = cat;
          renderCategories();
          renderChannels();
        };
        catDiv.appendChild(btn);
      });
    };

    const renderChannels = () => {
      const q = document.getElementById('search').value.toLowerCase();
      const list = document.getElementById('channelList');
      list.innerHTML = '';
      playlist.filter(p =>
        (currentCategory === 'All' || p.group === currentCategory) &&
        p.name.toLowerCase().includes(q)
      ).forEach(chan => {
        const div = document.createElement('div');
        div.className = 'channel';
        div.innerHTML = `<img src="${chan.logo}"/><div>${chan.name}</div>`;
        div.onclick = () => playChannel(chan);
        list.appendChild(div);
      });
    };

    const playChannel = (chan) => {
      const player = document.getElementById('player');
      currentChannel = chan;
      document.getElementById('nowChannel').innerText = 'Now Playing: ' + chan.name;
      player.src = chan.url;
      player.play();
    };

    // Smart Reconnect
    setInterval(() => {
      const video = document.getElementById('player');
      if (!currentChannel) return;
      if (video.paused || video.readyState < 2) {
        document.getElementById('reconnecting').style.display = 'block';
        playChannel(currentChannel);
      } else {
        document.getElementById('reconnecting').style.display = 'none';
      }
    }, 10000);

    const trackActivity = () => {
      setInterval(() => {
        if (document.hidden) {
          if (!offlineStart) offlineStart = Date.now();
        } else {
          offlineStart = null;
        }
        if (offlineStart && Date.now() - offlineStart > 3600000) {
          alert("Your 1 hour offline session has expired. Please login again.");
          logout();
        }
      }, 60000);
    };
  </script>
</body>
</html>
