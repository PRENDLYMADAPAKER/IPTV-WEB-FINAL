<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NZM IPTV</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    * { box-sizing: border-box; font-family: 'Orbitron', sans-serif; }
    body, html { margin: 0; padding: 0; background: black; color: white; height: 100%; }

    #loginSection {
      background: url('https://i.imgur.com/yeftKeD.jpeg') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .login-box {
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(10px);
      padding: 30px 40px;
      border-radius: 15px;
      text-align: center;
    }
    .login-box input, .login-box button {
      width: 250px;
      padding: 10px;
      margin: 10px auto;
      border-radius: 8px;
      border: none;
      font-size: 16px;
    }
    .login-box button {
      background: hotpink;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    #iptvSection { display: none; padding: 10px; background: #000; }
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .header img {
      width: 60px; height: 60px; border-radius: 50%; margin-right: 10px;
    }
    .logout-btn {
      margin-left: auto;
      background: crimson;
      padding: 6px 16px;
      border-radius: 8px;
      cursor: pointer;
    }

    video { width: 100%; border-radius: 10px; background: black; }
    #nowChannel { text-align: center; margin: 10px 0; font-weight: bold; font-size: 18px; }

    .carousel, #channelList {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      gap: 8px;
      padding: 10px;
    }
    .carousel button {
      background: #333;
      border: none;
      border-radius: 20px;
      color: white;
      padding: 8px 16px;
      flex-shrink: 0;
      scroll-snap-align: start;
    }
    .carousel button.active { background: hotpink; }

    .channel {
      flex: 0 0 48%;
      scroll-snap-align: start;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(6px);
      border-radius: 12px;
      padding: 10px;
      text-align: center;
    }
    .channel:hover { transform: scale(1.05); }
    .channel img { width: 100%; max-height: 100px; object-fit: contain; }

    #search {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      font-size: 16px;
    }
    #reconnecting {
      display: none;
      background: #0009;
      color: white;
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div id="loginSection">
    <div class="login-box">
      <h2>NZM IPTV Login</h2>
      <input type="text" id="username" placeholder="Username">
      <input type="password" id="password" placeholder="Password">
      <button onclick="loginUser()">Login</button>
      <p id="loginError" style="color:red;margin-top:10px"></p>
    </div>
  </div>

  <div id="iptvSection">
    <div class="header">
      <img src="logo.png" alt="Logo">
      <div class="logout-btn" onclick="logout()">Logout</div>
    </div>
    <video id="player" controls autoplay></video>
    <div id="reconnecting">Reconnecting stream...</div>
    <div id="nowChannel">Now Playing</div>
    <input type="text" id="search" placeholder="Search channels...">
    <div id="categoryList" class="carousel"></div>
    <div id="channelList"></div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDssixgarRWvLMKtUsX7HLEt8uPGmNIRak",
    authDomain: "iptv-login-3204b.firebaseapp.com",
    databaseURL: "https://iptv-login-3204b-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "iptv-login-3204b",
    storageBucket: "iptv-login-3204b.appspot.com",
    messagingSenderId: "464216999882",
    appId: "1:464216999882:web:d7e1f7d44adacd8b46b133"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let sessionId = navigator.userAgent + '_' + Math.random().toString(36).substring(2);

  function loginUser() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    const errorBox = document.getElementById("loginError");

    if (!username || !password) return errorBox.innerText = "Please enter all fields.";

    db.ref("users/" + username).once("value", snap => {
      if (!snap.exists()) return errorBox.innerText = "User does not exist.";

      const data = snap.val();
      if (data.password !== password) return errorBox.innerText = "Wrong password.";

      const now = new Date();
      const exp = new Date(data.expiration);
      if (now > exp) return errorBox.innerText = "Account expired.";

      let sessions = data.sessions || {};
      if (!sessions[sessionId]) sessions[sessionId] = Date.now();

      const sessionKeys = Object.keys(sessions);
      if (sessionKeys.length > (data.device_limit || 1)) {
        return errorBox.innerText = "Device limit reached.";
      }

      sessions[sessionId] = Date.now();
      db.ref("users/" + username + "/sessions").set(sessions).then(() => {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("iptvSection").style.display = "block";
        loadPlaylist();
      });
    });
  }

  function logout() {
    location.reload();
  }

  const m3uURL = "https://raw.githubusercontent.com/PRENDLYMADAPAKER/ANG-KALAT-MO/main/UDPTV.m3u";
  let channels = [], currentCategory = "All";

  function loadPlaylist() {
    fetch(m3uURL).then(res => res.text()).then(parseM3U);
    setInterval(() => fetch(m3uURL).then(res => res.text()).then(parseM3U), 180000);
  }

  function parseM3U(text) {
    channels = [];
    const lines = text.split("\n");
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].startsWith("#EXTINF")) {
        const name = lines[i].split(",").pop();
        const logo = lines[i].match(/tvg-logo="(.*?)"/)?.[1] || "";
        const group = lines[i].match(/group-title="(.*?)"/)?.[1] || "Other";
        const url = lines[i + 1];
        channels.push({ name, logo, group, url });
      }
    }
    renderCategories();
    renderChannels();
  }

  function renderCategories() {
    const cats = ["All", ...new Set(channels.map(c => c.group))];
    const catList = document.getElementById("categoryList");
    catList.innerHTML = "";
    cats.forEach(cat => {
      const btn = document.createElement("button");
      btn.innerText = cat;
      if (cat === currentCategory) btn.classList.add("active");
      btn.onclick = () => {
        currentCategory = cat;
        renderCategories();
        renderChannels();
      };
      catList.appendChild(btn);
    });
  }

  function renderChannels() {
    const list = document.getElementById("channelList");
    const query = document.getElementById("search").value.toLowerCase();
    list.innerHTML = "";
    channels.filter(c => (currentCategory === "All" || c.group === currentCategory) && c.name.toLowerCase().includes(query))
      .forEach(c => {
        const div = document.createElement("div");
        div.className = "channel";
        div.innerHTML = `<img src="${c.logo}" /><br>${c.name}`;
        div.onclick = () => playChannel(c);
        list.appendChild(div);
      });
  }

  function playChannel(channel) {
    const player = document.getElementById("player");
    const reconnect = document.getElementById("reconnecting");
    player.src = channel.url;
    document.getElementById("nowChannel").innerText = "Now Playing: " + channel.name;

    let lastTime = 0;
    setInterval(() => {
      if (player.paused || player.readyState < 2) return;
      if (player.currentTime === lastTime) {
        reconnect.style.display = "block";
        player.load();
        player.play();
      } else {
        reconnect.style.display = "none";
      }
      lastTime = player.currentTime;
    }, 10000);
  }

  document.getElementById("search").addEventListener("input", renderChannels);
</script>
</body>
</html>
