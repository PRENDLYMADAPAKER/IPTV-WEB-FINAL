<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NZM IPTV</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Orbitron:700&display=swap">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #000;
      color: #fff;
    }
    .loginBox {
      max-width: 400px;
      margin: 80px auto;
      background: #111;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px #ff007f;
      text-align: center;
    }
    .loginBox input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: none;
      background: #222;
      color: #fff;
    }
    .loginBox button {
      padding: 12px;
      background: #ff007f;
      border: none;
      width: 100%;
      color: #fff;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #111;
    }
    .logo {
      height: 50px;
    }
    .logoutBtn {
      background: #ff007f;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    #nowPlaying {
      background: #222;
      padding: 10px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }
    video {
      width: 100%;
      height: auto;
      background: #000;
    }
    .carousel {
      overflow-x: auto;
      white-space: nowrap;
      background: #111;
      padding: 10px;
    }
    .carousel button {
      background: #333;
      color: #fff;
      margin-right: 8px;
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    #channelGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      padding: 10px;
    }
    .channel {
      background: #222;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      font-size: 14px;
      cursor: pointer;
      transition: 0.3s;
    }
    .channel:hover {
      background: #ff007f;
    }
  </style>
</head>
<body>
  <div id="loginPage">
    <div class="loginBox">
      <h2>NZM IPTV Login</h2>
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p id="loginError" style="color: red;"></p>
    </div>
  </div>

  <div id="iptvInterface" style="display: none;">
    <header>
      <img src="logo.png" alt="NZM IPTV" class="logo" />
      <button onclick="logout()" class="logoutBtn">Logout</button>
    </header>
    <div id="nowPlaying">Now Playing: <span id="currentChannel">None</span></div>
    <video id="player" controls autoplay></video>
    <div id="categoryCarousel" class="carousel"></div>
    <div id="channelGrid"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA0TjMoFSYBIs0VQ9shUilOuDGb1uXHjKI",
      authDomain: "iptv-log-in.firebaseapp.com",
      databaseURL: "https://iptv-log-in-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "iptv-log-in",
      storageBucket: "iptv-log-in.appspot.com",
      messagingSenderId: "820026131349",
      appId: "1:820026131349:web:417abd6ad9057c55a92c9c"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    const loginPage = document.getElementById("loginPage");
    const iptvInterface = document.getElementById("iptvInterface");
    const player = document.getElementById("player");
    const currentChannel = document.getElementById("currentChannel");

    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      auth.signInWithEmailAndPassword(email, password)
        .then(() => document.getElementById("loginError").textContent = "")
        .catch(error => document.getElementById("loginError").textContent = error.message);
    }

    function logout() {
      auth.signOut().then(() => location.reload());
    }

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        loginPage.style.display = "none";
        iptvInterface.style.display = "block";

        const sessionId = localStorage.getItem("deviceId") || Math.random().toString(36).substring(2);
        localStorage.setItem("deviceId", sessionId);

        const sessionRef = db.ref(`sessions/${user.uid}/${sessionId}`);
        await sessionRef.set(true);
        sessionRef.onDisconnect().remove();

        sessionRef.on("value", snap => {
          if (!snap.exists()) {
            alert("You were force logged out by admin.");
            auth.signOut().then(() => location.reload());
          }
        });

        loadChannels();
      }
    });

    function loadChannels() {
      fetch("https://raw.githubusercontent.com/PRENDLYMADAPAKER/ANG-KALAT-MO/main/UDPTV.m3u")
        .then(res => res.text())
        .then(parseM3U);
    }

    function parseM3U(m3uText) {
      const lines = m3uText.split("\n");
      const categories = {};
      let currentGroup = "Uncategorized";

      lines.forEach((line, i) => {
        if (line.startsWith("#EXTINF")) {
          const title = line.split(",")[1]?.trim() || "Untitled";
          const groupMatch = line.match(/group-title="([^"]+)"/);
          currentGroup = groupMatch ? groupMatch[1] : "Uncategorized";
          const url = lines[i + 1]?.trim();

          if (!categories[currentGroup]) categories[currentGroup] = [];
          categories[currentGroup].push({ title, url });
        }
      });

      renderCategories(categories);
    }

    function renderCategories(categories) {
      const categoryBar = document.getElementById("categoryCarousel");
      const channelGrid = document.getElementById("channelGrid");
      categoryBar.innerHTML = "";
      channelGrid.innerHTML = "";

      const keys = Object.keys(categories);
      keys.forEach((cat, i) => {
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.onclick = () => renderChannels(categories[cat]);
        categoryBar.appendChild(btn);
        if (i === 0) renderChannels(categories[cat]);
      });
    }

    function renderChannels(channels) {
      const channelGrid = document.getElementById("channelGrid");
      channelGrid.innerHTML = "";
      channels.forEach(ch => {
        const div = document.createElement("div");
        div.className = "channel";
        div.innerHTML = `<strong>${ch.title}</strong>`;
        div.onclick = () => {
          player.src = ch.url;
          currentChannel.textContent = ch.title;
        };
        channelGrid.appendChild(div);
      });
    }
  </script>
</body>
</html>
